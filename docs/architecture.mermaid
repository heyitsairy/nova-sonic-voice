%%{init: {'theme': 'dark', 'themeVariables': {'primaryColor': '#4a90d9', 'primaryBorderColor': '#6db3f2', 'primaryTextColor': '#e8e8e8', 'lineColor': '#6db3f2', 'secondaryColor': '#2d5986', 'tertiaryColor': '#1a3a5c'}}}%%
graph TB
    subgraph Breeze["üñ•Ô∏è Breeze (Host Machine)"]
        subgraph Standalone["Standalone Mode"]
            MIC["üé§ C920 Mic<br/>16kHz mono"]
            SPK["üîä BT Speaker<br/>24kHz mono"]
            AGENT["NovaSonicVoiceAgent<br/>Mic capture + Playback"]
        end

        subgraph Discord_Mode["Discord Mode"]
            DVC["üéß Discord Voice<br/>48kHz stereo"]
            BRIDGE["NovaSonicBridge<br/>Format conversion<br/>Multi-user tracking"]
            SINK["NovaSonicAudioSink<br/>Discord ‚Üí Nova"]
            SOURCE["NovaSonicAudioSource<br/>Nova ‚Üí Discord"]
            THREAD["üìù Text Thread<br/>Real-time transcript"]
        end

        SESSION["NovaSonicSession<br/>WebSocket protocol<br/>Event routing<br/>Session continuation"]

        subgraph Orchestrator["üß† Nova-Calls-Airy Orchestrator"]
            ORCH["AiryOrchestrator<br/>Tag parser + Dispatcher"]
            TAGPARSE["Streaming tag detection<br/>Cross-chunk accumulation"]
            INJECT["Response injection<br/>Session reconnect"]
        end
    end

    subgraph AWS["‚òÅÔ∏è AWS Bedrock"]
        NOVA["Nova 2 Sonic<br/>amazon.nova-2-sonic-v1:0<br/>Bidirectional WebSocket"]
    end

    subgraph Discord_API["üí¨ Discord"]
        WEBHOOK["Nova Voice Webhook<br/>Posts prompts"]
        AIRY["Airy (Claude)<br/>Memory, tools, reasoning"]
    end

    MIC -->|"PCM 16kHz"| AGENT
    AGENT -->|"base64 LPCM"| SESSION
    SESSION -->|"audio + text"| AGENT
    AGENT -->|"PCM 24kHz"| SPK

    DVC -->|"48kHz stereo"| SINK
    SINK -->|"stereo‚Üímono<br/>48k‚Üí16k"| BRIDGE
    BRIDGE -->|"base64 LPCM"| SESSION
    SESSION -->|"audio + text"| BRIDGE
    BRIDGE -->|"mono‚Üístereo<br/>24k‚Üí48k"| SOURCE
    SOURCE -->|"48kHz stereo"| DVC
    BRIDGE -->|"transcript"| THREAD

    SESSION <-->|"SigV4 WebSocket<br/>Bidirectional stream"| NOVA

    SESSION -->|"assistant text"| ORCH
    ORCH --> TAGPARSE
    TAGPARSE -->|"&lt;airy&gt; tag detected"| WEBHOOK
    WEBHOOK -->|"prompt"| AIRY
    AIRY -->|"reply (polls)"| ORCH
    ORCH --> INJECT
    INJECT -->|"history + reconnect"| SESSION

    style Breeze fill:#1a1a2e,stroke:#4a90d9,color:#e8e8e8
    style Standalone fill:#16213e,stroke:#4a90d9,color:#e8e8e8
    style Discord_Mode fill:#16213e,stroke:#4a90d9,color:#e8e8e8
    style Orchestrator fill:#1a3a1a,stroke:#4ade80,color:#e8e8e8
    style AWS fill:#0f3460,stroke:#e94560,color:#e8e8e8
    style Discord_API fill:#3a1a4a,stroke:#a855f7,color:#e8e8e8
    style SESSION fill:#4a90d9,stroke:#6db3f2,color:#fff
    style NOVA fill:#e94560,stroke:#ff6b81,color:#fff
    style ORCH fill:#4ade80,stroke:#86efac,color:#1a1a2e
    style AIRY fill:#a855f7,stroke:#c084fc,color:#fff
    style WEBHOOK fill:#7c3aed,stroke:#a855f7,color:#fff
